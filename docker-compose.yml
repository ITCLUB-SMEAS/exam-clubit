services:
  # ==========================================================================
  # PHP-FPM Application
  # ==========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: cbt-app
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - app-storage:/var/www/html/storage/app
      - logs:/var/www/html/storage/logs
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_KEY_FILE=/run/secrets/app_key
      - APP_URL=${APP_URL}
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
    secrets:
      - app_key
      - db_password
      - redis_password
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - frontend
      - backend
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:mode=1770,uid=1000,gid=1000,size=64M
      - /var/www/html/storage/framework:mode=1770,uid=1000,gid=1000,size=64M
      - /var/www/html/bootstrap/cache:mode=1770,uid=1000,gid=1000,size=32M
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "SCRIPT_NAME=/fpm-ping SCRIPT_FILENAME=/fpm-ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:9000 2>/dev/null | grep -q pong"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ==========================================================================
  # Nginx Web Server
  # ==========================================================================
  nginx:
    build:
      context: .
      dockerfile: Dockerfile
      target: nginx
    container_name: cbt-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_SSL_PORT:-443}:443"
    volumes:
      - app-storage:/var/www/html/storage/app:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      app:
        condition: service_healthy
    networks:
      - frontend
      - backend
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /var/cache/nginx:mode=1770,uid=1000,gid=1000,size=64M
      - /var/run:mode=1770,uid=1000,gid=1000,size=8M
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 128M
        reservations:
          cpus: '0.25'
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # MySQL Database
  # ==========================================================================
  mysql:
    image: mysql:9.1
    container_name: cbt-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_root_password
      - db_password
    volumes:
      - mysql-data:/var/lib/mysql
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    networks:
      - backend
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    command: >
      --default-authentication-plugin=caching_sha2_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --skip-symbolic-links
      --local-infile=0
      --secure-file-priv=/var/lib/mysql-files

  # ==========================================================================
  # Redis Cache & Session
  # ==========================================================================
  redis:
    image: redis:7.4-alpine
    container_name: cbt-redis
    restart: unless-stopped
    command: >
      sh -c "redis-server
      --requirepass $$(cat /run/secrets/redis_password)
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --protected-mode yes
      --bind 0.0.0.0
      --rename-command FLUSHDB ''
      --rename-command FLUSHALL ''
      --rename-command DEBUG ''
      --rename-command CONFIG ''
      --rename-command KEYS ''
      --rename-command SHUTDOWN ''
      --rename-command SLAVEOF ''
      --rename-command REPLICAOF ''
      --rename-command BGSAVE ''
      --rename-command BGREWRITEAOF ''"
    secrets:
      - redis_password
    volumes:
      - redis-data:/data
    networks:
      - backend
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:mode=1770,size=32M
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a $$(cat /run/secrets/redis_password) ping 2>/dev/null | grep -q PONG"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # Queue Worker
  # ==========================================================================
  queue:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: cbt-queue
    restart: unless-stopped
    working_dir: /var/www/html
    command: php artisan queue:work redis --sleep=3 --tries=3 --max-time=3600
    volumes:
      - app-storage:/var/www/html/storage/app
      - logs:/var/www/html/storage/logs
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_KEY_FILE=/run/secrets/app_key
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - QUEUE_CONNECTION=redis
    secrets:
      - app_key
      - db_password
      - redis_password
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:mode=1770,uid=1000,gid=1000,size=64M
      - /var/www/html/storage/framework:mode=1770,uid=1000,gid=1000,size=32M
      - /var/www/html/bootstrap/cache:mode=1770,uid=1000,gid=1000,size=16M
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ==========================================================================
  # Scheduler (Cron)
  # ==========================================================================
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: cbt-scheduler
    restart: unless-stopped
    working_dir: /var/www/html
    command: sh -c "while true; do php artisan schedule:run --verbose --no-interaction; sleep 60; done"
    volumes:
      - app-storage:/var/www/html/storage/app
      - logs:/var/www/html/storage/logs
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_KEY_FILE=/run/secrets/app_key
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
    secrets:
      - app_key
      - db_password
      - redis_password
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:mode=1770,uid=1000,gid=1000,size=32M
      - /var/www/html/storage/framework:mode=1770,uid=1000,gid=1000,size=32M
      - /var/www/html/bootstrap/cache:mode=1770,uid=1000,gid=1000,size=16M
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M

# ==========================================================================
# Secrets (Docker Secrets for sensitive data)
# ==========================================================================
secrets:
  app_key:
    file: ./docker/secrets/app_key.txt
  db_root_password:
    file: ./docker/secrets/db_root_password.txt
  db_password:
    file: ./docker/secrets/db_password.txt
  redis_password:
    file: ./docker/secrets/redis_password.txt

# ==========================================================================
# Networks (Segmented for security)
# ==========================================================================
networks:
  frontend:
    driver: bridge
    internal: false
  backend:
    driver: bridge
    internal: true

# ==========================================================================
# Volumes (Named volumes for data persistence)
# ==========================================================================
volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  app-storage:
    driver: local
  logs:
    driver: local
